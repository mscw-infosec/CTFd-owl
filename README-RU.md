# CTFd-owl

Форкнуто от [CTFd-Owl](https://github.com/BIT-NSC/ctfd-owl.git) by BIT-NSC.

## Возможности

1. Несколько динамических контейнеров и портов на задание.
2. Порты рандомизированы для каждого запуска.
3. Адаптировано для обоих режимов CTFd: индивидуального и командного. В командном режиме запускается один инстанс на команду.
4. Флаг задания может быть как статическим (plaintext, или проверка regex), так и динамическим.
5. Флаг кладётся в переменную окружения FLAG при запуске `docker compose up`. Вы можете подтянуть его в нужный контейнер.
6. Конфигурация контейнера, от комментариев до проксирования, происходит декларативно через лейблы Docker Compose.

### Лейблы
Проксируемые контейнеры должны иметь как минимум первые два лейбла из следующих:
- `owl.proxy=true` - показывает CTFd-Owl, что контейнер нужно проксировать
- `owl.proxy.port=5656` - порт внутри контейнера, на который будет идти трафик (пр. 5656)
- `owl.label.conntype=nc` - показывается как `(nc)` перед `ip:port` в карточке задания
- `owl.label.comment=My comment.` - показывается как `(My comment.)` на следующей строке после `ip:port` в карточке задания

### Сети
Для того, чтобы FRP мог проксировать трафик в контейнер, он должен находиться в сети `net`, где `net`:
```
networks:
    net:
        external:
            name: ctfd_frp_containers
```

Тем не менее, в случае, когда в задании есть несколько контейнеров (пр. `service1` и `service2`), и `service1` делает
HTTP запрос к `http://service2`, то в случае, когда задание запущено у нескольких участников, в одной сети будет несколько
контейнеров с названием `service2`, что приведёт к тому, что Docker DNS будет отдавать несколько A-записей. 

Чтобы предотвратить это, в случае, если в вашем задании несколько сервисов, хотя бы один из которых общается с другим,
не помещайте сервис, которому не нужно проксирование в `net` - вместо этого создайте сеть с названием `CTFD_PRIVATE_NETWORK` и поместите его в неё.
`CTFD_PRIVATE_NETWORK` будет заменено плагином на строку формата `{prefix}_user{user_id}_{dirname}` в процессе настройки контейнеров.

## Установка

**REQUIRES: CTFd == v3.7.7**

Скрипт установки:

```shell
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# замените <workdir> на нужную вам директорию
cd <workdir>
git clone https://github.com/CTFd/CTFd.git -b 3.7.7
git clone https://github.com/mscw-infosec/CTFd-owl.git
cp -r CTFd-owl/* CTFd
mkdir -p /home/docker
```

Не забудьте заменить переменные `SECRET_KEY`, `MYSQL_PASSWORD` и другие подобные в вашем `single.yml`.

```shell
docker compose -f CTFd/single.yml up -d
```

Вы победили установку! :) Впереди конфигурация.

## Использование

### Конфигурация

#### Настройки Docker

![Docker Settings](./assets/ctfd-owl_admin_settings-docker.png)

|           Options            |                                                 Content                                                  |
|:----------------------------:|:--------------------------------------------------------------------------------------------------------:|
|    **Префикс флага**    |                                               Префикс флага                   |
|     **Docker API URL**      |                            API url/path (по умолчанию - `unix:///var/run/docker.sock)                            |
|   **Максимальное кол-во контейнеров**    |         Максимальное количество контейнеров (unlimited по умолчанию)   |
| **Таймаут контейнеров** | Максимальное время жизни контейнера (по истечении контейнер будет удалён) |
|     **Максимальное количество обновлений**     |                Максимальное количество обновлений времени жизни контейнера                 |

#### FRP Settings

![FRP Settings](./assets/ctfd-owl_admin_settings-frp.png)

|           Options           |                                                            Content                                                             |
|:---------------------------:|:------------------------------------------------------------------------------------------------------------------------------:|
| **Суффикс домена FRP**  | Суффикс домена FRP (нужен для динамического DNS, используется редко, по умолчанию `None`)                         |
|  **Базовый адрес FRP**  |   Адрес сервера с FRP, показывается участникам в связке `ip:port`                                |
| **Минимальный порт FRP** |          Минимальный порт (должен быть идентичен минимальному порту у `frps` в `single.yml`)          |
| **Максимальный порт FRP** | Максимальный порт (должен быть идентичен минимальному порту у `frps` в `single.yml`)                                                  |
|   **Шаблон конфигурации FRP**   | Шаблон конфига с данными FRP, на основе его обновляется `frpc.toml` |

Ниже приведён пример шаблона конфигурации FRP.
Пожалуйста, создайте случайную строку и замените ей значение `auth.token`. Не забудьте также обновить `auth.token` в `frp/conf/frps.toml` и `frp/conf/frpc.toml`.
```ini
serverAddr = "frps"
serverPort = 80

auth.method = "token" 
auth.token = "CHANGE_THIS_TOKEN_TO_RANDOM_VALUE"

webServer.addr = "10.1.0.4"
webServer.port = 7400
webServer.user = "admin"
webServer.password = "admin"

transport.tcpMux = false
transport.poolCount = 1
```

### Добавление задач

Пример задачи приведён в `CTFd/plugins/ctfd-owl/source/`. Вы можете создать свою задачу на её основе.

### Демо

На скриншотах использована тема pixo (автор - hmrserver, модифицирована michaelsantosti для v3.7.7 CTFd и JustMarfix для CTFd-Owl). Она доступна в папке `themes` этого репозитория.


![challenges.png](./assets/challenges.png)

![containers](./assets/ctfd-owl_admin_containers.png)

